<!-- Include Top Navbar -->
{{>top-nav}}
{{>top-nav-desktop}}

<!-- Main Content -->
<div class="container">
  <div class="card card--header">
    <h1 class="title">Edit Challenge</h1>
    <a class="icon icon--cancel" href="{{#if permissions.organisation_id}}/orgs/{{permissions.organisation_id}}{{else}}/orgs{{/if}}"></a>
  </div>

  {{#if error}}
  <div class="snackbar snackbar--error">
    <h1 class="snackbar__content snackbar__content--error">{{error.message}}</h1>
  </div>
  {{/if}}

    <form class="form form--desktop" method="post">
      <div class="form__section form__section--main">

        <label class="form__label" for="title">Title</label>
        <input class="form__input form__input--text {{error.title}}" type="text" name="title" id="title" value="{{#if error}}{{error.values.title}}{{else}}{{title}}{{/if}}">

        <label class="form__label" for="description">Description</label>
        <textarea class="form__input form__input--text-area {{error.description}}"
                  name="description"
                  id="description"
                  placeholder="Write Here..."
                  rows=""
                  cols="50"
                  >{{#if error.values.description}}{{error.values.description}}{{else}}{{description}}{{/if}}
        </textarea>

        {{#if tags}}
        <div class="form__section">

          <div id="tag__labels">
          {{#each tags}}
              <span class="tag__label">{{name}}</span>
          {{/each}}
        </div>
        </div>

        <button class="button" type="button" id="edit-tags">Edit tags<i class="icon icon--arrow-right icon--arrow-inside-button"></i></button>
        {{/if}}
      </div>

      <p class="copy form__copy">Clicking 'Save' will make your challenge public to the network</p>


      <button class="button" type="submit">Save & Publish<i class="icon icon--arrow-right icon--arrow-inside-button"></i></button>

      <!-- Show archive and primary user if admin is logged in -->
        <div class="form__section">

          <a class="form__anchor form__anchor--danger" href="/challenges/{{id}}/toggle-active">
            {{#if active}}
              Archive Challenge
            {{else}}
              Unarchive Challenge
            {{/if}}
          </a>
        </div>

        <div id="form-tag-ids">
          {{#each tags}}
              <input type="hidden" name="tags" value="{{id}}">
          {{/each}}
        </div>

    </form>

    {{>modal-tags}}
</div>


<script type="text/javascript">
  var editTagsButton = document.getElementById('edit-tags');
  var tagList = document.getElementById('tag-list');
  var selectTagsButton = document.getElementById('select-tags');
  var cancelTagsButton = document.getElementById('cancel-tags');
  var tag, i, j;

  // Helper functions
  function selectCheckbox(tags, categories) {
    // reset the selected elements
    var selectedTags = document.querySelectorAll('.tag__input:checked:not(.cat)');
    var selectedCategories = document.querySelectorAll('.cat:checked')
    unselect(selectedTags);
    unselect(selectedCategories);
    // select the tags based on the State
    for (i = 0; i < tags.length; i++) {
        document.getElementById('tag_' + tags[i].id).checked = true;
    }
    // select categories
    for (i = 0; i < categories.length; i++) {
        document.getElementById('cat_' + categories[i].category_id).checked = true;
    }
  }

  function unselect(elts) {
    for(i = 0; i < elts.length; i++) {
      elts[i].checked = false;
    }
  }

  function updateCurrentStateTags(tags) {
    var name;
    var state = [];
    for (i = 0; i < tags.length; i++) {
      name = tags[i].nextElementSibling.innerHTML
      state.push({id: tags[i].value, name: name})
    }
    return state;
  }

  function updateCurrentStateCategories(tags, tagCat) {
    var state = [];
    var catIds = [];
    var cat;
    for (i = 0; i < tags.length; i++) {
      cat = tagCat[tags[i].value];
      if(catIds.indexOf(cat.category_id) === -1) {
        state.push(cat);
      }
    }
    return state;
  }

  function updateTagNames(tags) {
    var tagLabelsList = document.getElementById('tag__labels');
    tagLabelsList.innerHTML = '';
    for (i = 0; i < tags.length; i++) {
      var newtagLabel = document.createElement('span')
      newtagLabel.className = 'tag__label'
      newtagLabel.innerHTML = tags[i].name
      tagLabelsList.append(newtagLabel)
    }
  }

  function hiddenInputTagIds(tags, div) {
    div.innerHTML = '';
    for (i = 0; i < tags.length; i++) {
      var inputTagId = document.createElement('input')
      inputTagId.type = 'hidden';
      inputTagId.name = 'tags';
      inputTagId.value = tags[i].id;
      div.append(inputTagId);
    }
  }

  // INITIAL STATES ON PAGE LOAD
  var currentStateTags = {{{"initialTags"}}};
  var currentStateCategories = {{{"initialCategories"}}}
  var tagCat = {{{"tagCat"}}}

  // OPEN MODAL
  editTagsButton.addEventListener('click', function(){
    selectCheckbox(currentStateTags, currentStateCategories);
    tagList.style.display = 'block'
  });

  // SELECT TAGS
  selectTagsButton.addEventListener('click', function() {
    var selectedTags = document.querySelectorAll('.tag__input:checked:not(.cat)');
    if (selectedTags.length < 10) {
      var inputTagIds = document.getElementById('form-tag-ids');
      currentStateTags = updateCurrentStateTags(selectedTags);
      currentStateCategories = updateCurrentStateCategories(selectedTags, tagCat);
      updateTagNames(currentStateTags);
      hiddenInputTagIds(currentStateTags, inputTagIds)
      tagList.style.display = 'none';
    }
  });


  cancelTagsButton.addEventListener('click', function() {
    tagList.style.display = 'none';
  })

</script>

<!-- Include Navbar -->
{{>navbar}}
